<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bullet Journal</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    *, ::before, ::after { box-sizing: border-box; }
    html, body {
      font-family: 'IBM Plex Mono', monospace;
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: transparent;
      color: #eee;
      text-transform: uppercase;
      overflow: hidden;
    }
    ::-webkit-scrollbar { display: none; }

    #wrapper {
      display: flex;
      flex-direction: row;
      padding: 40px 20px;
      width: 100%;
      gap: 32px;
      height: 100%;
    }

    @media (max-width: 700px) {
      #wrapper {
        flex-direction: column;
        padding: 20px 16px;
      }
      .panel {
        width: 100%;
        margin-bottom: 20px;
        padding: 16px;
      }
      #journal-panel {
        max-width: 100%;
        padding: 20px;
      }
    }

    .panel {
      width: 220px;
      flex-shrink: 0;
      padding: 28px;
      overflow-y: auto;
      max-height: calc(100vh - 60px);
    }

    .card {
      background: none;
      border: 1px solid #333;
      border-radius: 12px;
      margin-bottom: 20px;
      padding: 18px 16px;
      position: relative;
    }

    .card h2 {
      font-size: 0.75rem;
      margin: 0 0 12px;
      border-bottom: 1px solid #444;
      padding-bottom: 6px;
      font-weight: 700;
    }

    #calendar-btn {
      position: absolute;
      top: 10px;
      right: 12px;
      font-size: 1.2rem;
      background: none;
      border: none;
      color: #eee;
      cursor: pointer;
    }

    .item {
      font-size: 0.75rem;
      letter-spacing: 0.03em;
      cursor: pointer;
      margin-bottom: 8px;
      transition: opacity 0.2s;
      color: #888;
      display: flex;
      justify-content: space-between;
    }

    .item.active {
      font-weight: bold;
      color: #fff;
    }

    .item-controls {
      display: flex;
      gap: 6px;
      font-size: 0.65rem;
    }

    .icon-btn {
      border: none;
      background: none;
      color: #999;
      cursor: pointer;
      padding: 0 4px;
    }

    .icon-btn:hover { color: #fff; }

    .add-collection-link {
      font-size: 0.65rem;
      font-weight: 700;
      letter-spacing: 0.15em;
      margin-top: -9px;
      margin-bottom: 8px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }

    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      background: #111;
      padding: 20px;
      border: 1px solid #444;
      border-radius: 12px;
      z-index: 1002;
      color: #fff;
      width: 280px;
      max-width: 90vw;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .popup h3 {
      font-size: 0.75rem;
      margin: 0;
    }

    .popup p {
      font-size: 0.65rem;
      line-height: 1.4;
      margin: 0;
    }

    .popup input {
      width: 100%;
      padding: 6px;
      font-family: 'IBM Plex Mono', monospace;
      background: none;
      border: 1px solid #444;
      color: #fff;
      font-size: 0.75rem;
      margin: 0;
    }

    .popup-buttons {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .popup-buttons button {
      flex: 1;
      padding: 6px;
      font-size: 0.65rem;
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 0.08em;
      border-radius: 6px;
      background: none;
      color: #fff;
      border: 1px solid #fff;
      cursor: pointer;
    }

    .popup-buttons button:hover {
      background: #222;
    }

    /* Calendar Enhancements */
    #calendar-popup {
      max-height: 90vh;
      overflow: auto;
      overflow-x: hidden;
    }

    #calendar-grid > div {
      position: relative;
    }

    .calendar-today {
      border: 2px solid #0af !important;
      border-radius: 6px;
    }

    .calendar-entry-dot::after {
      content: '';
      display: block;
      width: 4px;
      height: 4px;
      background: #0af;
      border-radius: 50%;
      position: absolute;
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%);
    }

    .calendar-selected {
      background: #333;
    }

    @media (prefers-color-scheme: light) {
      html, body {
        background: transparent;
        color: #000;
      }
      .card, .panel, .notes, .popup-buttons button {
        border-color: #ccc;
        color: #000;
      }
      .item { color: #444; }
      .item.active { color: #000; font-weight: bold; }
      .icon-btn { color: #666; }
      .icon-btn:hover { color: #000; }
      .popup {
        background: #fff;
        color: #000;
        border-color: #aaa;
      }
      .popup input, .popup-buttons button {
        color: #111;
        border-color: #aaa;
        background: none;
      }
      .drag-toggle-btn, #calendar-btn { color: #000; }
      .calendar-today {
        border: 2px solid #00f !important;
      }
      .calendar-entry-dot::after {
        background: #00f;
      }
    }
  </style>
</head>
<body>
  <div id="wrapper">
    <div class="panel">
      <div class="card" id="index-card">
        <h2>INDEX</h2>
        <button id="calendar-btn" title="Create new date">+</button>
        <div class="item" data-entry="yesterday">YESTERDAY</div>
        <div class="item" data-entry="today">TODAY</div>
        <div class="item" data-entry="tomorrow">TOMORROW</div>

        <h2 style="margin-top: 18px;">RECENTS <span id="recents-toggle" style="float: right; cursor: pointer;">▼</span></h2>
        <div id="recent-entries" style="display: block;"></div>
      </div>

      <div id="collections-card" class="card">
        <h2>COLLECTIONS</h2>
        <span class="add-collection-link" onclick="toggleCollectionPopup()">+ ADD</span>
        <div id="collection-popup" class="popup" style="display:none;">
          <h3>NEW COLLECTION</h3>
          <input id="new-collection-name" placeholder="Collection name" />
          <div class="popup-buttons">
            <button onclick="createCollection()">SAVE</button>
            <button onclick="toggleCollectionPopup()">CANCEL</button>
          </div>
        </div>
        <div id="collections-list"></div>
      </div>
    </div>

    <div id="journal-panel">
      <div class="header">
        <div style="display: flex; flex-direction: column;">
          <div id="entry-title">DAILY LOG</div>
          <div id="entry-date">MON, APR 14</div>
        </div>
        <button class="drag-toggle-btn" id="dragToggleBtn" title="Toggle reorder mode">☰</button>
      </div>
      <div id="journal-content" class="notes" contenteditable="true"></div>
    </div>
  </div>
  <!-- Calendar Popup -->
  <div id="calendar-popup" class="popup" style="display:none;">
    <h3>DATE INPUT</h3>
    <p>PLEASE SELECT A DATE TO CREATE OR LOAD</p>
    <div id="calendar-header" style="display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; margin-bottom: 10px;">
      <button id="prev-month">&#8592;</button>
      <span id="calendar-month"></span>
      <button id="next-month">&#8594;</button>
    </div>
    <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 12px;"></div>
    <div class="popup-buttons calendar-popup-buttons">
      <button id="calendar-create" disabled>CREATE</button>
      <button onclick="calendarPopup.style.display='none'">CANCEL</button>
    </div>
  </div>

  <!-- Rename Collection -->
  <div id="rename-popup" class="popup" style="display:none;">
    <h3>RENAME COLLECTION</h3>
    <input id="rename-input" placeholder="New name" />
    <div class="popup-buttons">
      <button onclick="confirmRename()">SAVE</button>
      <button onclick="hideRenamePopup()">CANCEL</button>
    </div>
  </div>

  <!-- Delete Collection -->
  <div id="delete-popup" class="popup" style="display:none;">
    <h3>DELETE COLLECTION</h3>
    <p>ARE YOU SURE YOU WANT TO DELETE THIS COLLECTION?</p>
    <div class="popup-buttons">
      <button onclick="confirmDelete()">DELETE</button>
      <button onclick="hideDeletePopup()">CANCEL</button>
    </div>
  </div>

  <!-- Sync status footer -->
  <div id="sync-status">
    <span class="spinner" style="display:none;"></span>
    <span class="label">SYNCED</span>
  </div>

  <script>
  const content = document.getElementById("journal-content");
  const title = document.getElementById("entry-title");
  const dateLabel = document.getElementById("entry-date");
  const calendarPopup = document.getElementById("calendar-popup");
  const calendarGrid = document.getElementById("calendar-grid");
  const calendarMonthLabel = document.getElementById("calendar-month");
  const calendarCreateBtn = document.getElementById("calendar-create");

  let currentMode = "daily";
  let currentSlug = new Date().toISOString().slice(0, 10);
  let recentEntries = [];
  let dragMode = false;
  let selectedCalendarDate = null;
  let calendarDate = new Date();

  function getKey(mode, slug) {
    return `bujocache-${mode}-${slug}`;
  }

  function encodeHTML(str) {
    return btoa(unescape(encodeURIComponent(str)));
  }

  function decodeHTML(str) {
    return decodeURIComponent(escape(atob(str)));
  }

  function extractVersion(html) {
    const match = html.match(/<!-- version:(.*?)-->/);
    return match ? new Date(match[1]) : new Date(0);
  }

  function updateStatus(text, syncing = false) {
    document.querySelector("#sync-status .label").textContent = text;
    document.querySelector("#sync-status .spinner").style.display = syncing ? "inline-block" : "none";
  }

  function forceCheckboxAttrs() {
    content.querySelectorAll('input[type="checkbox"]').forEach(cb => {
      cb.checked ? cb.setAttribute("checked", "checked") : cb.removeAttribute("checked");
    });
  }

  function saveLocal() {
    const html = `<!-- version:${new Date().toISOString()} -->\n${content.innerHTML}`;
    localStorage.setItem(getKey(currentMode, currentSlug), encodeHTML(html));
  }

  function syncRemote() {
    const html = `<!-- version:${new Date().toISOString()} -->\n${content.innerHTML}`;
    updateStatus("SYNCING...", true);
    fetch("https://bujolebron.netlify.app/.netlify/functions/dispatch", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ date: currentSlug, content: encodeHTML(html), mode: currentMode })
    }).then(res => updateStatus(res.ok ? "SYNCED" : "NETLIFY ERROR"))
      .catch(() => updateStatus("SYNC FAILED"));
  }

  function debounceSync() {
    clearTimeout(window._syncTimeout);
    window._syncTimeout = setTimeout(syncRemote, 1000);
  }

  function saveContent() {
    forceCheckboxAttrs();
    saveLocal();
    debounceSync();
  }

  function formatPrettyDate(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleDateString("en-US", { weekday: "short", month: "short", day: "numeric" }).toUpperCase();
  }

  function ensureEditableLine() {
    if (content.innerHTML.trim() === "") addEntryLine("Start writing...");
  }

  function addEntryLine(text = "") {
    const div = document.createElement("div");
    div.className = "entry-line";
    if (dragMode) div.classList.add("drag-enabled");

    const drag = document.createElement("div");
    drag.className = "drag-handle";
    drag.textContent = "☰";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.onchange = saveContent;

    const txt = document.createElement("div");
    txt.className = "line-text";
    txt.contentEditable = !dragMode;
    txt.innerHTML = text;

    div.appendChild(drag);
    div.appendChild(cb);
    div.appendChild(txt);
    content.appendChild(div);
  }
  function highlightActive(slug) {
    document.querySelectorAll(".item").forEach(i => {
      const isMatch = i.dataset.entry === slug;
      i.classList.toggle("active", isMatch);
    });
  }

  function loadContent(mode, slug, label, url) {
    currentMode = mode;
    currentSlug = slug;
    title.textContent = label;
    dateLabel.textContent = (mode === "daily") ? formatPrettyDate(slug) : "";
    highlightActive(slug);

    const today = getTodaySlug();
    const yest = getTodaySlug(-1);
    const tomo = getTodaySlug(1);

    if (![today, yest, tomo].includes(slug)) {
      recentEntries = [slug, ...recentEntries.filter(s => s !== slug && ![today, yest, tomo].includes(s))].slice(0, 2);
      localStorage.setItem("recent-entries", JSON.stringify(recentEntries));
      renderRecents();
    }

    const cached = localStorage.getItem(getKey(mode, slug));
    const cachedHtml = cached ? decodeHTML(cached) : "";
    const cachedVer = extractVersion(cachedHtml);
    content.innerHTML = cachedHtml.replace(/<!--.*?-->/, "") || "";
    ensureEditableLine();
    updateStatus(cached ? "LOADED CACHED" : "EMPTY");

    fetch(url).then(res => res.ok ? res.text() : null).then(remote => {
      if (!remote) return;
      const remoteVer = extractVersion(remote);
      if (remoteVer > cachedVer) {
        content.innerHTML = remote.replace(/<!--.*?-->/, "");
        localStorage.setItem(getKey(mode, slug), encodeHTML(remote));
        updateStatus("LOADED SYNCED");
      }
    }).catch(() => updateStatus("OFFLINE"));
  }

  function renderRecents() {
    const box = document.getElementById("recent-entries");
    box.innerHTML = "";
    const today = getTodaySlug();
    const yest = getTodaySlug(-1);
    const tomo = getTodaySlug(1);
    recentEntries.filter(slug => ![today, yest, tomo].includes(slug)).forEach(slug => {
      const div = document.createElement("div");
      div.className = "item";
      div.dataset.entry = slug;
      div.textContent = slug;
      div.onclick = () => loadContent("daily", slug, "DAILY LOG", `https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/indexes/journal-${slug}.html`);
      box.appendChild(div);
    });
  }

  function getExistingJournalSlugs() {
    const slugs = [];
    for (let k in localStorage) {
      if (k.startsWith("bujocache-daily-")) {
        slugs.push(k.replace("bujocache-daily-", ""));
      }
    }
    return slugs;
  }

  function renderCalendar() {
    const year = calendarDate.getFullYear();
    const month = calendarDate.getMonth();
    const todaySlug = getTodaySlug();
    const existingSlugs = getExistingJournalSlugs();

    const daysInMonth = new Date(year, month + 1, 0).getDate();
    calendarMonthLabel.textContent = new Date(year, month).toLocaleString("default", { month: "long", year: "numeric" }).toUpperCase();
    calendarGrid.innerHTML = "";

    const firstDay = new Date(year, month, 1).getDay();
    for (let i = 0; i < firstDay; i++) {
      calendarGrid.appendChild(document.createElement("div"));
    }

    for (let d = 1; d <= daysInMonth; d++) {
      const cell = document.createElement("div");
      cell.textContent = d;
      cell.style.textAlign = "center";
      cell.style.padding = "6px";
      cell.style.border = "1px solid #444";
      cell.style.cursor = "pointer";
      const slug = new Date(year, month, d).toISOString().slice(0, 10);

      if (slug === todaySlug) cell.classList.add("calendar-today");
      if (existingSlugs.includes(slug)) cell.classList.add("calendar-entry-dot");

      cell.onclick = () => {
        selectedCalendarDate = slug;
        calendarCreateBtn.disabled = false;
        document.querySelectorAll("#calendar-grid div").forEach(c => c.classList.remove("calendar-selected"));
        cell.classList.add("calendar-selected");
      };
      calendarGrid.appendChild(cell);
    }
  }

  document.getElementById("calendar-btn").onclick = () => {
    calendarPopup.style.display = "flex";
    renderCalendar();
  };
  document.getElementById("prev-month").onclick = () => {
    calendarDate.setMonth(calendarDate.getMonth() - 1);
    renderCalendar();
  };
  document.getElementById("next-month").onclick = () => {
    calendarDate.setMonth(calendarDate.getMonth() + 1);
    renderCalendar();
  };
  calendarCreateBtn.onclick = () => {
    if (!selectedCalendarDate) return;
    const slug = selectedCalendarDate;
    calendarPopup.style.display = "none";
    loadContent("daily", slug, "DAILY LOG", `https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/indexes/journal-${slug}.html`);
  };
  // === Undo / Redo
  let undoStack = [], redoStack = [];

  function captureSnapshot() {
    const snapshot = content.innerHTML;
    undoStack.push(snapshot);
    redoStack = []; // clear redo history
  }

  function applySnapshot(snapshot) {
    if (!snapshot) return;
    content.innerHTML = snapshot;
    forceCheckboxAttrs();
    saveContent();
  }

  document.addEventListener("keydown", e => {
    if (e.metaKey || e.ctrlKey) {
      if (e.key === "z" && !e.shiftKey) {
        e.preventDefault();
        const snap = undoStack.pop();
        if (snap) {
          redoStack.push(content.innerHTML);
          applySnapshot(snap);
        }
      } else if ((e.key === "Z" && e.shiftKey) || e.key === "y") {
        e.preventDefault();
        const snap = redoStack.pop();
        if (snap) {
          undoStack.push(content.innerHTML);
          applySnapshot(snap);
        }
      }
    }
  });

  content.addEventListener("input", () => {
    captureSnapshot();
    saveContent();
  });

  // === Drag & Sort
  document.getElementById("dragToggleBtn").onclick = () => {
    dragMode = !dragMode;
    document.getElementById("dragToggleBtn").classList.toggle("active", dragMode);
    document.querySelectorAll(".entry-line").forEach(line => {
      line.classList.toggle("drag-enabled", dragMode);
      const txt = line.querySelector(".line-text");
      if (txt) txt.contentEditable = !dragMode;
      const dragIcon = line.querySelector(".drag-handle");
      if (dragIcon) dragIcon.style.display = dragMode ? "inline-block" : "none";
    });
  };

  new Sortable(content, {
    handle: ".drag-handle",
    animation: 150,
    draggable: ".entry-line",
    ghostClass: "sortable-ghost",
    onEnd: () => saveContent()
  });

  // === Collection Popups
  function toggleCollectionPopup() {
    const popup = document.getElementById("collection-popup");
    popup.style.display = popup.style.display === "none" ? "flex" : "none";
  }

  function createCollection() {
    const input = document.getElementById("new-collection-name");
    const name = input.value.trim().toUpperCase().replace(/\s+/g, "-");
    if (!name) return;
    const html = `<!-- version:${new Date().toISOString()} -->\n<div class="entry-line"><div class="drag-handle">☰</div><input type="checkbox"><div class="line-text">New collection: ${name}</div></div>`;
    fetch("https://bujolebron.netlify.app/.netlify/functions/dispatch", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ date: name, content: encodeHTML(html), mode: "collection" })
    }).then(() => {
      toggleCollectionPopup();
      input.value = "";
      if (!cachedCollectionSlugs.includes(name)) {
        cachedCollectionSlugs.unshift(name);
        localStorage.setItem("collections-list", JSON.stringify(cachedCollectionSlugs));
        renderCollections(cachedCollectionSlugs);
      }
    });
  }

  function confirmRename() {
    const newName = document.getElementById("rename-input").value.trim().toUpperCase().replace(/\s+/g, "-");
    if (!newName || !window._renameTarget) return;
    fetch("https://bujolebron.netlify.app/.netlify/functions/dispatch", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ rename: window._renameTarget, to: newName, mode: "collection" })
    }).then(() => {
      hideRenamePopup();
      loadCollectionsList();
    });
  }

  function confirmDelete() {
    if (!window._deleteTarget) return;
    fetch("https://bujolebron.netlify.app/.netlify/functions/dispatch", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ delete: window._deleteTarget, mode: "collection" })
    }).then(() => {
      hideDeletePopup();
      loadCollectionsList();
    });
  }

  function hideRenamePopup() {
    document.getElementById("rename-popup").style.display = "none";
  }

  function hideDeletePopup() {
    document.getElementById("delete-popup").style.display = "none";
  }

  let cachedCollectionSlugs = [];

  function loadCollectionsList() {
    const box = document.getElementById("collections-list");
    box.innerHTML = "";

    const stored = localStorage.getItem("collections-list");
    if (stored) {
      cachedCollectionSlugs = JSON.parse(stored);
      renderCollections(cachedCollectionSlugs);
    }

    fetch("https://api.github.com/repos/lebron1212/bulletjournal/contents/journals/collections")
      .then(res => res.ok ? res.json() : [])
      .then(data => {
        const slugs = data
          .filter(i => i.name.startsWith("collection-") && i.name.endsWith(".html"))
          .map(i => i.name.replace(".html", "").replace("collection-", ""));
        cachedCollectionSlugs = slugs;
        localStorage.setItem("collections-list", JSON.stringify(slugs));
        renderCollections(slugs);
      });
  }

  function renderCollections(slugs) {
    const box = document.getElementById("collections-list");
    box.innerHTML = "";
    slugs.forEach(slug => {
      const div = document.createElement("div");
      div.className = "item";
      div.dataset.entry = slug;
      div.textContent = slug;

      const ctrl = document.createElement("div");
      ctrl.className = "item-controls";

      const rename = document.createElement("button");
      rename.className = "icon-btn";
      rename.innerText = "✎";
      rename.onclick = e => {
        e.stopPropagation();
        window._renameTarget = slug;
        document.getElementById("rename-input").value = slug;
        document.getElementById("rename-popup").style.display = "flex";
      };

      const del = document.createElement("button");
      del.className = "icon-btn";
      del.innerText = "✕";
      del.onclick = e => {
        e.stopPropagation();
        window._deleteTarget = slug;
        document.getElementById("delete-popup").style.display = "flex";
      };

      ctrl.appendChild(rename);
      ctrl.appendChild(del);
      div.appendChild(ctrl);

      div.onclick = () => {
        loadContent("collection", slug, slug, `https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/collections/collection-${slug}.html`);
      };

      box.appendChild(div);
    });
  }

  // === Final Init
  window.onload = () => {
    const rec = localStorage.getItem("recent-entries");
    recentEntries = rec ? JSON.parse(rec) : [];
    renderRecents();
    loadCollectionsList();
    const slug = getTodaySlug();
    loadContent("daily", slug, "DAILY LOG", `https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/indexes/journal-${slug}.html`);
  };
  </script>
</body>
</html>
