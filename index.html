<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>Bullet Journal</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    html, body {
      font-family: 'IBM Plex Mono', monospace;
      margin: 0;
      padding: 0;
      height: 100%;
      background: transparent;
      color: #eee;
      text-transform: uppercase;
      overflow: hidden;
    }
    body.light-mode { color: #000; background: #fff; }
    ::-webkit-scrollbar { display: none; }

    #wrapper {
      display: flex;
      flex-direction: row;
      height: 100%;
      width: 100%;
      padding: 32px 20px;
      gap: 32px;
    }

    .panel {
      width: 240px;
      flex-shrink: 0;
      overflow-y: auto;
      max-height: calc(100vh - 60px);
    }

    #journal-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      opacity: 1;
      transition: opacity 0.25s ease-in-out;
    }

    .card {
      border: 1px solid #444;
      border-radius: 12px;
      margin-bottom: 24px;
      padding: 20px;
      background: none;
    }

    .card h2 {
      font-size: 0.75rem;
      margin: 0 0 16px;
      border-bottom: 1px solid #444;
      padding-bottom: 6px;
      font-weight: 700;
    }

    .item {
      font-size: 0.75rem;
      margin-bottom: 10px;
      color: #888;
      display: flex;
      justify-content: space-between;
      cursor: pointer;
    }

    .item.active {
      font-weight: bold;
      color: #fff;
    }

    .item-controls {
      display: flex;
      gap: 6px;
    }

    .icon-btn {
      border: none;
      background: none;
      color: #aaa;
      cursor: pointer;
      font-size: 0.7rem;
      padding: 0;
    }

    .icon-btn:hover {
      color: #fff;
    }

    .add-collection-link {
      font-size: 0.7rem;
      margin-top: -6px;
      margin-bottom: 10px;
      display: inline-block;
      cursor: pointer;
      font-weight: bold;
    }

    #calendar-btn {
      position: absolute;
      top: 14px;
      right: 16px;
      font-size: 1.2rem;
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
    }

    #entry-title {
      font-size: 0.9rem;
      font-weight: bold;
      margin-bottom: 4px;
    }

    #entry-date {
      font-size: 0.7rem;
      color: #aaa;
    }

    #journal-content {
      flex: 1;
      overflow-y: auto;
      padding-right: 6px;
    }
    .entry-line {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .entry-line input[type="checkbox"] {
      appearance: none;
      width: 16px;
      height: 16px;
      border: 1px solid #999;
      display: inline-block;
      position: relative;
      cursor: pointer;
      background: transparent;
    }

    .entry-line input[type="checkbox"]:checked::after {
      content: "X";
      color: #0ff;
      font-size: 0.8rem;
      position: absolute;
      top: 0;
      left: 2px;
    }

    .entry-line .line-text {
      flex: 1;
      outline: none;
      min-height: 18px;
      padding: 2px 0;
      word-break: break-word;
    }

    .entry-line.checked .line-text {
      text-decoration: line-through;
      opacity: 0.6;
    }

    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      background: #111;
      border: 1px solid #444;
      padding: 20px;
      width: 280px;
      max-width: 95vw;
      z-index: 1000;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .popup h3 {
      font-size: 0.75rem;
      margin: 0;
    }

    .popup p {
      font-size: 0.65rem;
      margin: 0;
      line-height: 1.4;
    }

    .popup input {
      padding: 6px;
      font-family: 'IBM Plex Mono', monospace;
      background: none;
      border: 1px solid #444;
      color: #fff;
      font-size: 0.75rem;
      width: 100%;
    }

    .popup-buttons {
      display: flex;
      gap: 8px;
    }

    .popup-buttons button {
      flex: 1;
      padding: 6px;
      font-size: 0.7rem;
      font-weight: bold;
      border-radius: 6px;
      background: none;
      color: #fff;
      border: 1px solid #fff;
      cursor: pointer;
    }

    .popup-buttons button:hover {
      background: #222;
    }

    #sync-status {
      position: fixed;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.65rem;
      opacity: 0.8;
    }

    @media (max-width: 700px) {
      #wrapper {
        flex-direction: column;
        padding: 20px 14px;
        gap: 20px;
      }
      .panel {
        width: 100%;
      }
      #journal-panel {
        min-height: 300px;
      }
      .entry-line .drag-handle {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="wrapper">
    <div class="panel">
      <div class="card" id="index-card">
        <h2>INDEX</h2>
        <button id="calendar-btn" title="Create new date">+</button>
        <div class="item" data-entry="yesterday">YESTERDAY</div>
        <div class="item" data-entry="today">TODAY</div>
        <div class="item" data-entry="tomorrow">TOMORROW</div>

        <h2 style="margin-top: 18px;">RECENTS <span id="recents-toggle" style="float: right; cursor: pointer;">▼</span></h2>
        <div id="recent-entries" style="display: block;"></div>
      </div>

      <div id="collections-card" class="card">
        <h2>COLLECTIONS</h2>
        <span class="add-collection-link" onclick="toggleCollectionPopup()">+ ADD</span>
        <div id="collections-list"></div>
      </div>
    </div>

    <div id="journal-panel" class="card">
      <div class="header">
        <div>
          <div id="entry-title">DAILY LOG</div>
          <div id="entry-date">MON, APR 14</div>
        </div>
      </div>
      <div id="journal-content" class="notes" contenteditable="true"></div>
    </div>
  </div>

  <!-- Calendar Popup -->
  <div id="calendar-popup" class="popup" style="display: none;">
    <h3>DATE INPUT</h3>
    <p>PLEASE SELECT A DATE TO CREATE OR LOAD</p>
    <div id="calendar-header" style="display: flex; justify-content: space-between; align-items: center;">
      <button id="prev-month">&#8592;</button>
      <span id="calendar-month"></span>
      <button id="next-month">&#8594;</button>
    </div>
    <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin: 12px 0;"></div>
    <div class="popup-buttons">
      <button id="calendar-create" disabled>GO</button>
      <button onclick="calendarPopup.style.display='none'">CANCEL</button>
    </div>
  </div>

  <!-- Create Collection Popup -->
  <div id="collection-popup" class="popup" style="display:none;">
    <h3>NEW COLLECTION</h3>
    <input id="new-collection-name" placeholder="Collection name" />
    <div class="popup-buttons">
      <button onclick="createCollection()">SAVE</button>
      <button onclick="toggleCollectionPopup()">CANCEL</button>
    </div>
  </div>

  <!-- Rename Collection Popup -->
  <div id="rename-popup" class="popup" style="display:none;">
    <h3>RENAME COLLECTION</h3>
    <input id="rename-input" placeholder="New name" />
    <div class="popup-buttons">
      <button onclick="confirmRename()">SAVE</button>
      <button onclick="hideRenamePopup()">CANCEL</button>
    </div>
  </div>

  <!-- Delete Collection Popup -->
  <div id="delete-popup" class="popup" style="display:none;">
    <h3>DELETE COLLECTION</h3>
    <p>ARE YOU SURE YOU WANT TO DELETE THIS COLLECTION?</p>
    <div class="popup-buttons">
      <button onclick="confirmDelete()">DELETE</button>
      <button onclick="hideDeletePopup()">CANCEL</button>
    </div>
  </div>

  <!-- Sync Status -->
  <div id="sync-status">
    <span class="spinner" style="display:none;">⏳</span>
    <span class="label">SYNCED</span>
  </div>
<script>
const content = document.getElementById("journal-content");

// === ENTRY UTILS ===
function ensureEditableLine() {
  if (content.innerHTML.trim() === "") addEntryLine("Start writing...");
}
function addEntryLine(text = "") {
  const div = document.createElement("div");
  div.className = "entry-line";

  const cb = document.createElement("input");
  cb.type = "checkbox";
  cb.onchange = () => {
    formatCompletedLine(cb);
    saveContent();
  };

  const txt = document.createElement("div");
  txt.className = "line-text";
  txt.contentEditable = true;
  txt.innerHTML = text;

  div.appendChild(cb);
  div.appendChild(txt);
  content.appendChild(div);
}
function formatCompletedLine(cb) {
  const line = cb.parentElement.querySelector(".line-text");
  if (cb.checked) {
    line.style.textDecoration = "line-through";
    cb.outerHTML = '<span class="checkbox-x">X</span>';
  } else {
    cb.outerHTML = '<input type="checkbox">';
  }
}
function reformatCheckboxes() {
  content.querySelectorAll('.entry-line').forEach(line => {
    const cb = line.querySelector("input[type='checkbox']");
    if (cb && cb.checked) formatCompletedLine(cb);
  });
}

// === RECENTS ===
function renderRecents() {
  const box = document.getElementById("recent-entries");
  box.innerHTML = "";
  const today = getTodaySlug();
  const yest = getTodaySlug(-1);
  const tomo = getTodaySlug(1);
  const reserved = [today, yest, tomo];

  recentEntries.filter(slug => !reserved.includes(slug) && !slug.startsWith("collection-")).forEach(slug => {
    const div = document.createElement("div");
    div.className = "item";
    div.dataset.entry = slug;
    div.textContent = slug;
    div.onclick = () => loadContent("daily", slug, "DAILY LOG", `https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/indexes/journal-${slug}.html`);
    box.appendChild(div);
  });
}

// === TODAY / YESTERDAY / TOMORROW LOAD ===
function attachStaticLoaders() {
  const today = getTodaySlug();
  const yest = getTodaySlug(-1);
  const tomo = getTodaySlug(1);

  document.querySelector('[data-entry="today"]').onclick = () =>
    loadContent("daily", today, "DAILY LOG", `https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/indexes/journal-${today}.html`);

  document.querySelector('[data-entry="yesterday"]').onclick = () =>
    loadContent("daily", yest, "DAILY LOG", `https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/indexes/journal-${yest}.html`);

  document.querySelector('[data-entry="tomorrow"]').onclick = () =>
    loadContent("daily", tomo, "DAILY LOG", `https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/indexes/journal-${tomo}.html`);
}
// === SYNC + SAVE ===
function saveLocal() {
  const html = `<!-- version:${new Date().toISOString()} -->\n${content.innerHTML}`;
  localStorage.setItem(`bujocache-${currentMode}-${currentSlug}`, encodeHTML(html));
}
function syncRemote() {
  const html = `<!-- version:${new Date().toISOString()} -->\n${content.innerHTML}`;
  updateStatus("SYNCING...", true);
  fetch("https://bujolebron.netlify.app/.netlify/functions/dispatch", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ date: currentSlug, content: encodeHTML(html), mode: currentMode })
  }).then(res => updateStatus(res.ok ? "SYNCED" : "NETLIFY ERROR"))
    .catch(() => updateStatus("SYNC FAILED"));
}
function debounceSync() {
  clearTimeout(window._syncTimeout);
  window._syncTimeout = setTimeout(syncRemote, 800);
}
function saveContent() {
  saveLocal();
  debounceSync();
  pushUndoState();
}

// === UNDO / REDO ===
let undoStack = [], redoStack = [];
function pushUndoState() {
  undoStack.push(content.innerHTML);
  if (undoStack.length > 50) undoStack.shift();
  redoStack = [];
}
function undo() {
  if (undoStack.length > 1) {
    redoStack.push(undoStack.pop());
    content.innerHTML = undoStack[undoStack.length - 1];
    reformatCheckboxes();
    saveContent();
  }
}
function redo() {
  if (redoStack.length) {
    const state = redoStack.pop();
    undoStack.push(state);
    content.innerHTML = state;
    reformatCheckboxes();
    saveContent();
  }
}

// === SHORTCUTS ===
document.addEventListener("keydown", e => {
  if ((e.metaKey || e.ctrlKey) && e.key === "z" && !e.shiftKey) {
    undo(); e.preventDefault();
  } else if ((e.metaKey || e.ctrlKey) && (e.key === "Z" || (e.shiftKey && e.key === "z"))) {
    redo(); e.preventDefault();
  } else if ((e.metaKey || e.ctrlKey) && e.key === "b") {
    document.execCommand("bold"); e.preventDefault();
  } else if ((e.metaKey || e.ctrlKey) && e.key === "i") {
    document.execCommand("italic"); e.preventDefault();
  } else if ((e.metaKey || e.ctrlKey) && e.key === "u") {
    document.execCommand("underline"); e.preventDefault();
  }
});

// === CALENDAR POPUP ===
document.getElementById("calendar-btn").onclick = () => {
  document.getElementById("calendar-popup").style.display = "flex";
  selectedCalendarDate = null;
  renderCalendar();
};

document.getElementById("prev-month").onclick = () => {
  calendarDate.setMonth(calendarDate.getMonth() - 1);
  renderCalendar();
};
document.getElementById("next-month").onclick = () => {
  calendarDate.setMonth(calendarDate.getMonth() + 1);
  renderCalendar();
};
calendarCreateBtn.onclick = () => {
  if (!selectedCalendarDate) return;
  document.getElementById("calendar-popup").style.display = "none";
  loadContent("daily", selectedCalendarDate, "DAILY LOG", `https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/indexes/journal-${selectedCalendarDate}.html`);
};

// === PAGE SWITCH ANIMATION ===
function fadeTransition(callback) {
  const panel = document.getElementById("journal-panel");
  panel.style.opacity = "0.4";
  setTimeout(() => {
    callback();
    panel.style.opacity = "1";
  }, 150);
}
const originalLoadContent = loadContent;
loadContent = function (...args) {
  fadeTransition(() => originalLoadContent.apply(this, args));
};
// === INIT ===
window.onload = () => {
  const today = getTodaySlug();
  const yesterday = getTodaySlug(-1);
  const tomorrow = getTodaySlug(1);

  document.querySelector('[data-entry="today"]').onclick = () =>
    loadContent("daily", today, "DAILY LOG", `https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/indexes/journal-${today}.html`);

  document.querySelector('[data-entry="yesterday"]').onclick = () =>
    loadContent("daily", yesterday, "DAILY LOG", `https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/indexes/journal-${yesterday}.html`);

  document.querySelector('[data-entry="tomorrow"]').onclick = () =>
    loadContent("daily", tomorrow, "DAILY LOG", `https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/indexes/journal-${tomorrow}.html`);

  // Load collections from GitHub
  loadCollectionsList();

  // Load recents and today's entry
  recentEntries = JSON.parse(localStorage.getItem("recent-entries") || "[]");
  renderRecents();
  loadContent("daily", today, "DAILY LOG", `https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/indexes/journal-${today}.html`);
};
</script>

<style>
  /* Hide scrollbar in Notion embed */
  ::-webkit-scrollbar { display: none; }
  body {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  /* Reformat checkbox completion visuals */
  .entry-line input[type="checkbox"]:checked + .line-text {
    text-decoration: line-through;
    opacity: 0.6;
    position: relative;
  }

  .entry-line input[type="checkbox"]::before {
    content: " ";
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 1px solid #999;
    margin-right: 6px;
    background: transparent;
  }

  .entry-line input[type="checkbox"]:checked::before {
    content: "X";
    display: inline-block;
    width: 16px;
    height: 16px;
    text-align: center;
    line-height: 16px;
    color: #0ff;
    font-size: 0.75rem;
    font-weight: bold;
  }

  /* Fix sync indicator */
  #sync-status {
    left: 50%;
    transform: translateX(-50%);
    bottom: 10px;
    text-align: center;
  }
</style>
</body>
</html>
