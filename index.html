<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bullet Journal</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    *, ::after, ::before { box-sizing: border-box; }
    html, body {
      font-family: 'IBM Plex Mono', monospace;
      text-transform: uppercase;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      color: #eee;
    }
    body { display: flex; flex-direction: column; }

    #wrapper {
      display: flex;
      flex-direction: row;
      padding: 40px 20px;
      width: 100%;
      gap: 32px;
    }

    @media (max-width: 700px) {
      #wrapper {
        flex-direction: column;
        padding: 20px 16px;
      }
      .panel {
        width: 100%;
        margin: 0 0 20px 0;
        padding: 16px;
      }
      #journal-panel {
        max-width: 100%;
        padding: 20px;
      }
    }

    .panel {
      width: 220px;
      flex-shrink: 0;
      padding: 28px;
      position: relative;
    }

    #calendar-btn {
      position: absolute;
      top: 10px;
      right: 12px;
      font-size: 0.7rem;
      background: none;
      border: 1px solid #666;
      color: #eee;
      padding: 0px 5px 1px;
      border-radius: 4px;
      cursor: pointer;
    }

    #calendar-popup {
      position: fixed;
      top: 60px;
      right: 20px;
      background: #111;
      padding: 8px;
      border: 1px solid #444;
      border-radius: 8px;
      display: none;
      z-index: 999;
    }

    #calendar-popup input[type="date"] {
      font-family: 'IBM Plex Mono', monospace;
      background: none;
      border: 1px solid #444;
      color: #fff;
      padding: 4px 6px;
      font-size: 0.7rem;
      text-transform: none;
    }

    .card {
      background: none;
      border: 1px solid #333;
      border-radius: 12px;
      margin-bottom: 20px;
      padding: 18px 16px;
      position: relative;
    }

    .card h2 {
      font-size: 0.75rem;
      margin: 0 0 12px;
      border-bottom: 1px solid #444;
      padding-bottom: 6px;
      font-weight: 700;
    }

    .card .item {
      font-size: 0.75rem;
      letter-spacing: 0.03em;
      cursor: pointer;
      margin-bottom: 8px;
      transition: opacity 0.2s;
      color: #aaa;
      display: flex;
      justify-content: space-between;
    }

    .card .item.active {
      font-weight: bold;
      color: #fff;
    }

    .item-controls {
      display: flex;
      gap: 6px;
      font-size: 0.65rem;
    }

    .icon-btn {
      border: none;
      background: none;
      color: #999;
      cursor: pointer;
      padding: 0 4px;
    }

    .icon-btn:hover { color: #fff; }

    .add-collection-link {
      font-size: 0.65rem;
      font-weight: 700;
      letter-spacing: 0.15em;
      margin-top: -9px;
      margin-bottom: 8px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }

    #collection-popup {
      display: none;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }

    #collection-popup input {
      width: 100%;
      padding: 6px;
      border: 1px solid #444;
      border-radius: 4px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.75rem;
      text-transform: none;
      background: none;
      color: #fff;
    }

    .popup-buttons {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .popup-buttons button {
      flex: 1;
      padding: 6px;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 700;
      border-radius: 6px;
      background: none;
      color: #eee;
      border: 1px solid #444;
      cursor: pointer;
    }

    .popup-buttons button:hover { background: #222; }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      font-size: 0.8rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      position: relative;
    }

    #entry-title { z-index: 1; }
    #entry-date {
      font-size: 0.65rem;
      color: #888;
      margin-top: 2px;
      margin-left: 8px;
      font-weight: 400;
    }
    .notes[contenteditable=true] {
      outline: 0;
      flex-grow: 1;
      font-size: 0.85rem;
      line-height: 1.9;
      letter-spacing: 0.04em;
      background: none;
    }

    #sync-status {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.6rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #999;
      font-weight: 500;
      pointer-events: none;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #sync-status .spinner {
      width: 10px;
      height: 10px;
      border: 1.5px solid #888;
      border-top: 1.5px solid transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .entry-line {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 12px;
    }

    .entry-line input[type=checkbox] {
      appearance: none;
      width: 18px;
      height: 18px;
      border: 1px solid #eee;
      background: none;
      position: relative;
      cursor: pointer;
      margin-top: 4px;
      border-radius: 4px;
      flex-shrink: 0;
      box-sizing: border-box;
      vertical-align: top;
    }

    .entry-line input[type=checkbox]:checked::after {
      content: "X";
      font-size: 16px;
      position: absolute;
      top: -1px;
      left: 3px;
      color: #eee;
    }

    .entry-line .line-text {
      flex-grow: 1;
      white-space: pre-wrap;
      word-break: break-word;
      outline: none;
      line-height: 1.8;
      min-height: 24px;
    }

    .entry-line input[type=checkbox]:checked ~ .line-text {
      text-decoration: line-through;
      opacity: 0.5;
    }

    #index-search {
      display: block;
      width: 100%;
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      margin-bottom: 10px;
      padding: 6px 8px;
      background: none;
      border: 1px solid #333;
      border-radius: 6px;
      color: #eee;
    }

    #hide-wrapper {
      position: fixed;
      bottom: 12px;
      left: 12px;
      font-size: 0.6rem;
      color: #aaa;
      background: none;
      padding: 6px 10px;
      border-radius: 6px;
      z-index: 1000;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #hide-wrapper input {
      transform: scale(1.2);
    }

    @media (prefers-color-scheme: light) {
      html, body {
        background: transparent;
        color: #000;
      }
      .card, .panel, .notes, .popup-buttons button {
        border-color: #ccc;
        background: none;
        color: #000;
      }
      .card h2, .icon-btn, .add-collection-link,
      #index-search, #collection-popup input {
        color: #111;
        border-color: #ccc;
        background: none;
      }
      .icon-btn:hover { color: #000; }
      #sync-status { color: #666; }
      .entry-line input[type="checkbox"] { border: 1px solid #000; }
      .entry-line input[type="checkbox"]:checked::after { color: #000; }
      #hide-wrapper { color: #333; }
      #calendar-popup input[type="date"] {
        color: #111;
        background: none;
        border-color: #aaa;
      }
    }
  </style>
</head>
<body>
  <div id="wrapper">
    <div class="panel">
      <div class="card" id="index-card">
        <h2>INDEX</h2>
        <button id="calendar-btn">+</button>
        <div id="calendar-popup"><input type="date" id="calendar-input" /></div>
        <input id="index-search" placeholder="search YYYY-MM-DD" oninput="filterIndex()" />
        <div class="item" data-entry="yesterday">YESTERDAY</div>
        <div class="item" data-entry="today">TODAY</div>
        <div class="item" data-entry="tomorrow">TOMORROW</div>
      </div>

      <div id="collections-card" class="card">
        <h2>COLLECTIONS</h2>
        <span class="add-collection-link" onclick="toggleCollectionPopup()">+ ADD</span>
        <div id="collection-popup">
          <input id="new-collection-name" placeholder="Collection name" />
          <div class="popup-buttons">
            <button onclick="createCollection()">Save</button>
            <button onclick="toggleCollectionPopup()">Cancel</button>
          </div>
        </div>
        <div id="collections-list"></div>
      </div>
    </div>

    <div id="journal-panel">
      <div class="header">
        <div style="display: flex; align-items: baseline;">
          <div id="entry-title">DAILY LOG</div>
          <div id="entry-date">MON, APR 14</div>
        </div>
      </div>
      <div id="journal-content" class="notes" contenteditable="true"></div>
    </div>
  </div>

  <div id="sync-status">
    <span class="spinner" style="display:none;"></span>
    <span class="label">SYNCED</span>
  </div>

  <div id="hide-wrapper">
    <label><input type="checkbox" id="hide-completed" onchange="toggleCompleted()" /> HIDE COMPLETED</label>
  </div>
<script>
const content = document.getElementById("journal-content");
const dateLabel = document.getElementById("entry-date");
const title = document.getElementById("entry-title");
const calendarBtn = document.getElementById("calendar-btn");
const calendarPopup = document.getElementById("calendar-popup");
const calendarInput = document.getElementById("calendar-input");
const collectionsListContainer = document.getElementById("collections-list");

let currentMode = "daily";
let currentSlug = new Date().toISOString().slice(0, 10);
let collectionsList = [];
let undoStack = [], redoStack = [];

function updateStatus(text, isSyncing = false) {
  const label = document.querySelector("#sync-status .label");
  const spinner = document.querySelector("#sync-status .spinner");
  label.textContent = text;
  spinner.style.display = isSyncing ? "inline-block" : "none";
}

function forceCheckboxAttributes() {
  content.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.checked ? cb.setAttribute("checked", "checked") : cb.removeAttribute("checked");
  });
}

function saveContent() {
  forceCheckboxAttributes();
  const html = `<!-- version:${new Date().toISOString()} -->\n` + content.innerHTML;
  const encoded = btoa(unescape(encodeURIComponent(html)));
  const key = `bujocache-${currentMode}-${currentSlug}`;
  localStorage.setItem(key, encoded);

  updateStatus("SYNCING...", true);
  fetch("https://bujolebron.netlify.app/.netlify/functions/dispatch", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ date: currentSlug, content: encoded, mode: currentMode })
  })
  .then(res => updateStatus(res.ok ? "SYNCED" : "NETLIFY ERROR"))
  .catch(() => updateStatus("APPTION ERROR"));
}

function debounceSave() {
  clearTimeout(window._saveTimeout);
  window._saveTimeout = setTimeout(() => {
    undoStack.push(content.innerHTML);
    redoStack = [];
    saveContent();
  }, 800);
}

function restoreFromCache() {
  const key = `bujocache-${currentMode}-${currentSlug}`;
  const cached = localStorage.getItem(key);
  if (cached) {
    content.innerHTML = decodeURIComponent(escape(atob(cached))).replace(/<!-- version:.*?-->\n?/i, "");
    updateStatus("LOADED CACHED");
    return true;
  }
  return false;
}

function ensureVisibleContent() {
  if (content.innerHTML.trim() === "") {
    const div = document.createElement("div");
    div.className = "entry-line";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.addEventListener("change", debounceSave);

    const text = document.createElement("div");
    text.className = "line-text";
    text.contentEditable = true;
    text.innerHTML = "Start writing...";

    div.appendChild(checkbox);
    div.appendChild(text);
    content.appendChild(div);
  }
}

function formatPrettyDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString("en-US", { weekday: "short", month: "short", day: "numeric" }).toUpperCase();
}

function highlightActive(slugOrDate) {
  document.querySelectorAll("#index-card .item, #collections-list .item").forEach(el => el.classList.remove("active"));
  const el = document.querySelector(`[data-entry="${slugOrDate}"]`);
  if (el) el.classList.add("active");
  else {
    const collectionEl = [...document.querySelectorAll("#collections-list .item")]
      .find(el => el.innerText.includes(slugOrDate.toUpperCase()));
    if (collectionEl) collectionEl.classList.add("active");
  }
}

function loadSyncedContent(date) {
  currentMode = "daily";
  currentSlug = date;
  title.textContent = "DAILY LOG";
  dateLabel.textContent = formatPrettyDate(date);

  const today = new Date().toISOString().slice(0, 10);
  const diff = Math.floor((new Date(date) - new Date(today)) / (1000 * 60 * 60 * 24));
  const relative = diff === 0 ? "today" : diff === -1 ? "yesterday" : diff === 1 ? "tomorrow" : null;
  highlightActive(relative || date);

  if (!restoreFromCache()) {
    content.innerHTML = "";
    ensureVisibleContent();
  }

  fetch(`https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/indexes/journal-${date}.html?cb=${Date.now()}`)
    .then(res => res.ok ? res.text() : Promise.reject())
    .then(html => {
      content.innerHTML = html.replace(/<!-- version:.*?-->\n?/i, "");
      updateStatus("LOADED SYNCED");
      debounceSave();
    })
    .catch(() => updateStatus("OFFLINE"));
}

function loadCollection(slug) {
  currentMode = "collection";
  currentSlug = slug;
  title.textContent = slug.toUpperCase();
  dateLabel.textContent = "";
  highlightActive(slug);

  if (!restoreFromCache()) {
    content.innerHTML = "";
    ensureVisibleContent();
  }

  fetch(`https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/collections/collection-${slug}.html?cb=${Date.now()}`)
    .then(res => res.ok ? res.text() : Promise.reject())
    .then(html => {
      content.innerHTML = html.replace(/<!-- version:.*?-->\n?/i, "");
      updateStatus("LOADED SYNCED");
      debounceSave();
    })
    .catch(() => updateStatus("OFFLINE"));
}

function toggleCompleted() {
  const hide = document.getElementById("hide-completed").checked;
  document.querySelectorAll(".entry-line").forEach(el => {
    const cb = el.querySelector('input[type="checkbox"]');
    const done = cb?.checked;
    el.classList.toggle("done", done);
    el.style.display = hide && done ? "none" : "flex";
  });
}

function toggleCollectionPopup() {
  const popup = document.getElementById("collection-popup");
  popup.style.display = popup.style.display === "flex" ? "none" : "flex";
}

function createCollection() {
  const nameInput = document.getElementById("new-collection-name");
  const name = nameInput.value.trim();
  if (!name) return;
  const slug = name.toLowerCase();
  if (!collectionsList.includes(slug)) {
    collectionsList.push(slug);
    renderCollectionItem(slug);
    saveCollectionsIndex();
  }
  nameInput.value = "";
  toggleCollectionPopup();
}

function renderCollectionItem(slug) {
  const div = document.createElement("div");
  div.className = "item";
  div.innerHTML =
    `<span onclick="loadCollection('${slug}')">${slug.toUpperCase()}</span>
     <span class="item-controls">
       <button class="icon-btn" onclick="renameCollectionPrompt('${slug}')">✎</button>
       <button class="icon-btn" onclick="deleteCollection('${slug}')">🗑</button>
     </span>`;
  collectionsListContainer.appendChild(div);
}

function renameCollectionPrompt(oldSlug) {
  const newName = prompt("Rename collection:", oldSlug.toUpperCase());
  if (!newName) return;
  const newSlug = newName.trim().toLowerCase();
  const index = collectionsList.indexOf(oldSlug);
  if (index !== -1) {
    collectionsList[index] = newSlug;
    saveCollectionsIndex();
    loadCollectionsList();
  }
}

function deleteCollection(slug) {
  if (!confirm(`Delete collection "${slug.toUpperCase()}"?`)) return;
  collectionsList = collectionsList.filter(s => s !== slug);
  saveCollectionsIndex();
  loadCollectionsList();
}

function saveCollectionsIndex() {
  fetch("https://bujolebron.netlify.app/.netlify/functions/dispatch", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      mode: "collections-index",
      date: "collections-index",
      content: btoa(unescape(encodeURIComponent(JSON.stringify(collectionsList))))
    })
  });
}

function loadCollectionsList() {
  collectionsListContainer.innerHTML = "";
  fetch("https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/collections/collections-index.json")
    .then(res => res.ok ? res.json() : [])
    .then(data => {
      collectionsList = data;
      data.forEach(renderCollectionItem);
      highlightActive(currentSlug);
    })
    .catch(() => collectionsList = []);
}

function filterIndex() {
  const q = document.getElementById("index-search").value.toLowerCase();
  document.querySelectorAll('#index-card .item').forEach(el => {
    el.style.display = el.textContent.toLowerCase().includes(q) ? "block" : "none";
  });
}

document.querySelector('[data-entry="today"]').addEventListener("click", () => {
  loadSyncedContent(new Date().toISOString().slice(0, 10));
});
document.querySelector('[data-entry="yesterday"]').addEventListener("click", () => {
  const d = new Date(); d.setDate(d.getDate() - 1);
  loadSyncedContent(d.toISOString().slice(0, 10));
});
document.querySelector('[data-entry="tomorrow"]').addEventListener("click", () => {
  const d = new Date(); d.setDate(d.getDate() + 1);
  loadSyncedContent(d.toISOString().slice(0, 10));
});

calendarBtn.addEventListener("click", () => {
  calendarPopup.style.display = calendarPopup.style.display === "block" ? "none" : "block";
});
calendarInput.addEventListener("change", e => {
  if (e.target.value) {
    loadSyncedContent(e.target.value);
    calendarPopup.style.display = "none";
  }
});

content.addEventListener("input", debounceSave);
content.addEventListener("change", debounceSave);
content.addEventListener("keydown", e => {
  const isMac = navigator.platform.toUpperCase().includes("MAC");
  const meta = isMac ? e.metaKey : e.ctrlKey;

  if (meta && e.key === "z" && !e.shiftKey) {
    e.preventDefault();
    if (undoStack.length) {
      redoStack.push(content.innerHTML);
      content.innerHTML = undoStack.pop();
      debounceSave();
    }
  }

  if ((meta && e.key === "Z") || (meta && e.shiftKey && e.key === "z")) {
    e.preventDefault();
    if (redoStack.length) {
      undoStack.push(content.innerHTML);
      content.innerHTML = redoStack.pop();
      debounceSave();
    }
  }

  if (e.key === "Enter") {
    e.preventDefault();
    const div = document.createElement("div");
    div.className = "entry-line";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.addEventListener("change", debounceSave);

    const text = document.createElement("div");
    text.className = "line-text";
    text.contentEditable = true;
    text.innerHTML = "&nbsp;";

    div.appendChild(checkbox);
    div.appendChild(text);
    content.appendChild(div);

    const sel = window.getSelection();
    const range = document.createRange();
    range.setStart(text, 0);
    range.collapse(true);
    sel.removeAllRanges();
    sel.addRange(range);

    debounceSave();
  }
});

loadCollectionsList();
loadSyncedContent(currentSlug);
</script>
</body>
</html>
