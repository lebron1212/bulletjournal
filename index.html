<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bullet Journal</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    *, ::before, ::after { box-sizing: border-box; }
    html, body {
      font-family: 'IBM Plex Mono', monospace;
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: transparent;
      color: #eee;
      text-transform: uppercase;
      overflow: hidden;
    }
    ::-webkit-scrollbar { display: none; }

    #wrapper {
      display: flex;
      flex-direction: row;
      padding: 40px 20px;
      width: 100%;
      gap: 32px;
      height: 100%;
    }

    @media (max-width: 700px) {
      #wrapper {
        flex-direction: column;
        padding: 20px 16px;
      }
      .panel {
        width: 100%;
        margin-bottom: 20px;
        padding: 16px;
      }
      #journal-panel {
        max-width: 100%;
        padding: 20px;
      }
    }

    .panel {
      width: 220px;
      flex-shrink: 0;
      padding: 28px;
      overflow-y: auto;
      max-height: calc(100vh - 60px);
    }

    .card {
      background: none;
      border: 1px solid #333;
      border-radius: 12px;
      margin-bottom: 20px;
      padding: 18px 16px;
      position: relative;
    }

    .card h2 {
      font-size: 0.75rem;
      margin: 0 0 12px;
      border-bottom: 1px solid #444;
      padding-bottom: 6px;
      font-weight: 700;
    }

    #calendar-btn {
      position: absolute;
      top: 10px;
      right: 12px;
      font-size: 1.2rem;
      background: none;
      border: none;
      color: #eee;
      cursor: pointer;
    }

    .item {
      font-size: 0.75rem;
      letter-spacing: 0.03em;
      cursor: pointer;
      margin-bottom: 8px;
      transition: opacity 0.2s;
      color: #888;
      display: flex;
      justify-content: space-between;
    }

    .item.active {
      font-weight: bold;
      color: #fff;
    }

    .item-controls {
      display: flex;
      gap: 6px;
      font-size: 0.65rem;
    }

    .icon-btn {
      border: none;
      background: none;
      color: #999;
      cursor: pointer;
      padding: 0 4px;
    }

    .icon-btn:hover { color: #fff; }

    .add-collection-link {
      font-size: 0.65rem;
      font-weight: 700;
      letter-spacing: 0.15em;
      margin-top: -9px;
      margin-bottom: 8px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }

    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      background: #111;
      padding: 20px;
      border: 1px solid #444;
      border-radius: 12px;
      z-index: 1002;
      color: #fff;
      width: 260px;
      max-width: 90vw;
    }

    .popup h3 {
      font-size: 0.75rem;
      margin: 0 0 8px;
    }

    .popup input {
      width: 100%;
      padding: 6px;
      font-family: 'IBM Plex Mono', monospace;
      background: none;
      border: 1px solid #444;
      color: #fff;
      font-size: 0.75rem;
      margin-bottom: 10px;
    }

    .popup-buttons {
      display: flex;
      gap: 8px;
    }

    .popup-buttons button {
      flex: 1;
      padding: 6px;
      font-size: 0.65rem;
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 0.08em;
      border-radius: 6px;
      background: none;
      color: #fff;
      border: 1px solid #fff;
      cursor: pointer;
    }

    .popup-buttons button:hover {
      background: #222;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      font-size: 0.8rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      margin-bottom: 20px;
      position: relative;
    }

    #entry-date {
      font-size: 0.65rem;
      color: #888;
      font-weight: 400;
      margin-top: 2px;
    }

    .notes[contenteditable=true] {
      outline: 0;
      flex-grow: 1;
      font-size: 0.85rem;
      line-height: 1.9;
      letter-spacing: 0.04em;
      background: none;
      overflow-y: auto;
      height: calc(100vh - 160px);
    }

    .entry-line {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 12px;
      cursor: grab;
    }

    .drag-handle {
      font-size: 0.9rem;
      cursor: grab;
      user-select: none;
      flex-shrink: 0;
      display: none;
      opacity: 0.5;
    }

    .entry-line.drag-enabled .drag-handle {
      display: inline-block;
    }

    .entry-line input[type=checkbox] {
      appearance: none;
      width: 18px;
      height: 18px;
      border: 1px solid #eee;
      background: none;
      position: relative;
      cursor: pointer;
      margin-top: 4px;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .entry-line input[type=checkbox]:checked::after {
      content: "X";
      font-size: 16px;
      position: absolute;
      top: -1px;
      left: 3px;
      color: #eee;
    }

    .entry-line .line-text {
      flex-grow: 1;
      white-space: pre-wrap;
      word-break: break-word;
      outline: none;
      line-height: 1.8;
      min-height: 24px;
    }

    .entry-line input[type=checkbox]:checked ~ .line-text {
      text-decoration: line-through;
      opacity: 0.5;
    }

    .drag-toggle-btn {
      position: absolute;
      right: 0;
      top: 0;
      font-size: 1.1rem;
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      padding: 4px;
    }

    .drag-toggle-btn.active {
      color: #0af;
    }

    #sync-status {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.6rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #999;
      font-weight: 500;
      pointer-events: none;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #sync-status .spinner {
      width: 10px;
      height: 10px;
      border: 1.5px solid #888;
      border-top: 1.5px solid transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (prefers-color-scheme: light) {
      html, body {
        background: transparent;
        color: #000;
      }
      .card, .panel, .notes, .popup-buttons button {
        border-color: #ccc;
        color: #000;
      }
      .item { color: #444; }
      .item.active { color: #000; font-weight: bold; }
      .icon-btn { color: #666; }
      .icon-btn:hover { color: #000; }
      .popup {
        background: #fff;
        color: #000;
        border-color: #aaa;
      }
      .popup input, .popup-buttons button {
        color: #111;
        border-color: #aaa;
        background: none;
      }
      .drag-toggle-btn, #calendar-btn { color: #000; }
      .entry-line input[type="checkbox"] { border-color: #000; }
      .entry-line input[type="checkbox"]:checked::after { color: #000; }
    }
  </style>
</head>
<body>
  <div id="wrapper">
    <div class="panel">
      <div class="card" id="index-card">
        <h2>INDEX</h2>
        <button id="calendar-btn" title="Create new date">+</button>
        <div class="item" data-entry="yesterday">YESTERDAY</div>
        <div class="item" data-entry="today">TODAY</div>
        <div class="item" data-entry="tomorrow">TOMORROW</div>

        <h2 style="margin-top: 18px;">RECENTS <span id="recents-toggle" style="float: right; cursor: pointer;">▼</span></h2>
        <div id="recent-entries" style="display: block;"></div>
      </div>

      <div id="collections-card" class="card">
        <h2>COLLECTIONS</h2>
        <span class="add-collection-link" onclick="toggleCollectionPopup()">+ ADD</span>
        <div id="collection-popup" class="popup" style="display:none;">
          <h3>NEW COLLECTION</h3>
          <input id="new-collection-name" placeholder="Collection name" />
          <div class="popup-buttons">
            <button onclick="createCollection()">SAVE</button>
            <button onclick="toggleCollectionPopup()">CANCEL</button>
          </div>
        </div>
        <div id="collections-list"></div>
      </div>
    </div>

    <div id="journal-panel">
      <div class="header">
        <div style="display: flex; flex-direction: column;">
          <div id="entry-title">DAILY LOG</div>
          <div id="entry-date">MON, APR 14</div>
        </div>
        <button class="drag-toggle-btn" id="dragToggleBtn" title="Toggle reorder mode">☰</button>
      </div>
      <div id="journal-content" class="notes" contenteditable="true"></div>
    </div>
  </div>

  <div id="sync-status">
    <span class="spinner" style="display:none;"></span>
    <span class="label">SYNCED</span>
  </div>

  <div id="rename-popup" class="popup" style="display:none;">
    <h3>RENAME COLLECTION</h3>
    <input id="rename-input" placeholder="New name" />
    <div class="popup-buttons">
      <button onclick="confirmRename()">SAVE</button>
      <button onclick="hideRenamePopup()">CANCEL</button>
    </div>
  </div>

  <div id="delete-popup" class="popup" style="display:none;">
    <h3>DELETE COLLECTION</h3>
    <p style="font-size: 0.65rem; margin-bottom: 12px;">Are you sure you want to delete this collection?</p>
    <div class="popup-buttons">
      <button onclick="confirmDelete()">DELETE</button>
      <button onclick="hideDeletePopup()">CANCEL</button>
    </div>
  </div>

  <div id="calendar-popup" class="popup" style="display:none;">
    <h3>DATE INPUT</h3>
    <p style="font-size: 0.65rem;">PLEASE INPUT THE DATE YOU'D LIKE TO CREATE</p>
    <div id="calendar-header" style="display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; margin-bottom: 10px;">
      <button id="prev-month">&#8592;</button>
      <span id="calendar-month"></span>
      <button id="next-month">&#8594;</button>
    </div>
    <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 12px;"></div>
    <div class="calendar-popup-buttons popup-buttons">
      <button id="calendar-create">CREATE</button>
      <button onclick="calendarPopup.style.display='none'">CANCEL</button>
    </div>
  </div>
<script>
let currentMode = "daily";
let currentSlug = new Date().toISOString().slice(0, 10);
let collectionsList = [];
let recentEntries = [];
let selectedCalendarSlug = null;
let renameTargetSlug = "";
let deleteTargetSlug = "";
let dragMode = false;
let calendarDate = new Date();

const content = document.getElementById("journal-content");
const title = document.getElementById("entry-title");
const dateLabel = document.getElementById("entry-date");
const calendarPopup = document.getElementById("calendar-popup");

function getKey(mode, slug) {
  return `bujocache-${mode}-${slug}`;
}
function encodeHTML(str) {
  return btoa(unescape(encodeURIComponent(str)));
}
function decodeHTML(str) {
  return decodeURIComponent(escape(atob(str)));
}
function updateStatus(text, isSyncing = false) {
  const label = document.querySelector("#sync-status .label");
  const spinner = document.querySelector("#sync-status .spinner");
  label.textContent = text;
  spinner.style.display = isSyncing ? "inline-block" : "none";
}
function saveLocal() {
  const html = `<!-- version:${new Date().toISOString()} -->\n${content.innerHTML}`;
  localStorage.setItem(getKey(currentMode, currentSlug), encodeHTML(html));
}
function syncRemote() {
  const html = `<!-- version:${new Date().toISOString()} -->\n${content.innerHTML}`;
  updateStatus("SYNCING...", true);
  fetch("https://bujolebron.netlify.app/.netlify/functions/dispatch", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      date: currentSlug,
      content: encodeHTML(html),
      mode: currentMode
    })
  }).then(res => {
    updateStatus(res.ok ? "SYNCED" : "NETLIFY ERROR");
  }).catch(() => updateStatus("SYNC FAILED"));
}
function debounceSync() {
  clearTimeout(window._syncTimeout);
  window._syncTimeout = setTimeout(syncRemote, 1000);
}
function forceCheckboxAttrs() {
  content.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.checked ? cb.setAttribute("checked", "checked") : cb.removeAttribute("checked");
  });
}
function saveContent() {
  forceCheckboxAttrs();
  saveLocal();
  debounceSync();
}
function extractVersion(html) {
  const match = html.match(/<!-- version:(.*?)-->/);
  return match ? new Date(match[1]) : new Date(0);
}
function formatPrettyDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString("en-US", { weekday: "short", month: "short", day: "numeric" }).toUpperCase();
}
function highlightActive(slug) {
  document.querySelectorAll(".item").forEach(i => i.classList.remove("active"));
  document.querySelector(`.item[data-entry="${slug}"]`)?.classList.add("active");
}
function ensureEditableLine() {
  if (content.innerHTML.trim() === "") addEntryLine("Start writing...");
}
function addEntryLine(text = "") {
  const div = document.createElement("div");
  div.className = "entry-line";
  if (dragMode) div.classList.add("drag-enabled");

  const drag = document.createElement("div");
  drag.className = "drag-handle";
  drag.textContent = "☰";

  const cb = document.createElement("input");
  cb.type = "checkbox";
  cb.addEventListener("change", saveContent);

  const txt = document.createElement("div");
  txt.className = "line-text";
  txt.contentEditable = !dragMode;
  txt.innerHTML = text;

  div.appendChild(drag);
  div.appendChild(cb);
  div.appendChild(txt);
  content.appendChild(div);
}

function loadContent(mode, slug, label, url) {
  currentMode = mode;
  currentSlug = slug;
  title.textContent = label;
  dateLabel.textContent = (mode === "daily") ? formatPrettyDate(slug) : "";
  highlightActive(slug);

  if (!["today", "yesterday", "tomorrow"].includes(slug)) {
    recentEntries = [slug, ...recentEntries.filter(s => s !== slug)].slice(0, 2);
    localStorage.setItem("recent-entries", JSON.stringify(recentEntries));
    renderRecents();
  }

  const cached = localStorage.getItem(getKey(mode, slug));
  const cachedHtml = cached ? decodeHTML(cached) : "";
  const cachedVer = extractVersion(cachedHtml);

  content.innerHTML = cachedHtml.replace(/<!--.*?-->/, "") || "";
  ensureEditableLine();
  updateStatus(cached ? "LOADED CACHED" : "EMPTY");

  fetch(url)
    .then(res => res.ok ? res.text() : null)
    .then(remote => {
      if (!remote) return;
      const remoteVer = extractVersion(remote);
      if (remoteVer > cachedVer) {
        content.innerHTML = remote.replace(/<!--.*?-->/, "");
        localStorage.setItem(getKey(mode, slug), encodeHTML(remote));
        updateStatus("LOADED SYNCED");
      }
    })
    .catch(() => updateStatus("OFFLINE"));
}

function renderRecents() {
  const box = document.getElementById("recent-entries");
  box.innerHTML = "";
  recentEntries
    .filter(slug => !["today", "yesterday", "tomorrow"].includes(slug))
    .forEach(slug => {
      const div = document.createElement("div");
      div.className = "item";
      div.dataset.entry = slug;
      div.textContent = slug;
      div.onclick = () => loadContent("daily", slug, "DAILY LOG", `https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/indexes/journal-${slug}.html`);
      box.appendChild(div);
    });
}

document.querySelector('[data-entry="today"]').onclick = () =>
  loadContent("daily", new Date().toISOString().slice(0, 10), "DAILY LOG", `https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/indexes/journal-${new Date().toISOString().slice(0, 10)}.html`);
document.querySelector('[data-entry="yesterday"]').onclick = () => {
  const d = new Date(); d.setDate(d.getDate() - 1);
  const slug = d.toISOString().slice(0, 10);
  loadContent("daily", slug, "DAILY LOG", `https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/indexes/journal-${slug}.html`);
};
document.querySelector('[data-entry="tomorrow"]').onclick = () => {
  const d = new Date(); d.setDate(d.getDate() + 1);
  const slug = d.toISOString().slice(0, 10);
  loadContent("daily", slug, "DAILY LOG", `https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/indexes/journal-${slug}.html`);
};

document.getElementById("dragToggleBtn").onclick = () => {
  dragMode = !dragMode;
  document.getElementById("dragToggleBtn").classList.toggle("active", dragMode);
  document.querySelectorAll(".entry-line").forEach(line => {
    line.classList.toggle("drag-enabled", dragMode);
    const txt = line.querySelector(".line-text");
    if (txt) txt.contentEditable = !dragMode;
  });
};
new Sortable(content, {
  handle: ".drag-handle",
  animation: 150,
  draggable: ".entry-line",
  ghostClass: "sortable-ghost",
  onEnd: () => saveContent()
});

content.addEventListener("input", saveContent);
content.addEventListener("change", saveContent);

document.getElementById("recents-toggle").onclick = () => {
  const box = document.getElementById("recent-entries");
  const isOpen = box.style.display !== "none";
  box.style.display = isOpen ? "none" : "block";
  document.getElementById("recents-toggle").textContent = isOpen ? "▶" : "▼";
};

document.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    addEntryLine("&nbsp;");
    const last = content.querySelector(".entry-line:last-child .line-text");
    if (last) {
      const range = document.createRange();
      range.selectNodeContents(last);
      range.collapse(false);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      last.focus();
    }
    saveContent();
  }
});
</script>
<script>
function toggleCollectionPopup() {
  const popup = document.getElementById("collection-popup");
  popup.style.display = popup.style.display === "none" ? "flex" : "none";
}

function renderCollectionItem(slug) {
  const div = document.createElement("div");
  div.className = "item";
  div.dataset.entry = slug;
  div.innerHTML = `
    <span onclick="loadCollection('${slug}')">${slug.toUpperCase()}</span>
    <span class="item-controls">
      <button class="icon-btn" onclick="showRenamePopup('${slug}')">✎</button>
      <button class="icon-btn" onclick="showDeletePopup('${slug}')">🗑</button>
    </span>`;
  document.getElementById("collections-list").appendChild(div);
}

function saveCollections() {
  const json = JSON.stringify(collectionsList);
  localStorage.setItem("bujocache-collections-index", encodeHTML(json));
  debounceSyncCollectionList();
}

function loadCollectionsList() {
  document.getElementById("collections-list").innerHTML = "";
  const local = localStorage.getItem("bujocache-collections-index");

  fetch("https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/collections/collections-index.json")
    .then(res => res.ok ? res.text() : null)
    .then(remote => {
      const localData = local ? decodeHTML(local) : "";
      const localVer = extractVersion(localData);
      const remoteVer = extractVersion(remote);
      if (remoteVer > localVer && remote) {
        collectionsList = JSON.parse(remote);
        localStorage.setItem("bujocache-collections-index", encodeHTML(remote));
      } else if (localData) {
        collectionsList = JSON.parse(localData);
      }
      collectionsList.forEach(renderCollectionItem);
      highlightActive(currentSlug);
    }).catch(() => {
      if (local) {
        collectionsList = JSON.parse(decodeHTML(local));
        collectionsList.forEach(renderCollectionItem);
      }
    });
}

function createCollection() {
  const name = document.getElementById("new-collection-name").value.trim().toLowerCase();
  if (!name || collectionsList.includes(name)) return;
  collectionsList.push(name);
  saveCollections();
  toggleCollectionPopup();
  loadCollectionsList();
  loadCollection(name);
}

function showRenamePopup(slug) {
  renameTargetSlug = slug;
  document.getElementById("rename-input").value = slug.toUpperCase();
  document.getElementById("rename-popup").style.display = "flex";
}
function hideRenamePopup() {
  document.getElementById("rename-popup").style.display = "none";
}
function confirmRename() {
  const newName = document.getElementById("rename-input").value.trim().toLowerCase();
  if (!newName || newName === renameTargetSlug) return;
  const i = collectionsList.indexOf(renameTargetSlug);
  if (i !== -1) collectionsList[i] = newName;
  saveCollections();
  hideRenamePopup();
  loadCollectionsList();
  if (currentSlug === renameTargetSlug && currentMode === "collection")
    loadCollection(newName);
}

function showDeletePopup(slug) {
  deleteTargetSlug = slug;
  document.getElementById("delete-popup").style.display = "flex";
}
function hideDeletePopup() {
  document.getElementById("delete-popup").style.display = "none";
}
function confirmDelete() {
  collectionsList = collectionsList.filter(s => s !== deleteTargetSlug);
  saveCollections();
  hideDeletePopup();
  loadCollectionsList();
  if (currentSlug === deleteTargetSlug && currentMode === "collection") {
    loadContent("daily", new Date().toISOString().slice(0, 10), "DAILY LOG", `https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/indexes/journal-${new Date().toISOString().slice(0, 10)}.html`);
  }
}

function loadCollection(slug) {
  currentMode = "collection";
  currentSlug = slug;
  title.textContent = slug.toUpperCase();
  dateLabel.textContent = "";
  highlightActive(slug);

  const cached = localStorage.getItem(getKey("collection", slug));
  const cachedHtml = cached ? decodeHTML(cached) : "";
  const cachedVer = extractVersion(cachedHtml);

  content.innerHTML = cachedHtml.replace(/<!--.*?-->/, "") || "";
  ensureEditableLine();

  fetch(`https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/collections/collection-${slug}.html`)
    .then(res => res.ok ? res.text() : null)
    .then(remote => {
      if (!remote) return;
      const remoteVer = extractVersion(remote);
      if (remoteVer > cachedVer) {
        content.innerHTML = remote.replace(/<!--.*?-->/, "");
        localStorage.setItem(getKey("collection", slug), encodeHTML(remote));
        updateStatus("LOADED SYNCED");
      }
    })
    .catch(() => updateStatus("OFFLINE"));
}

// CALENDAR
function buildCalendarGrid(date) {
  const grid = document.getElementById("calendar-grid");
  grid.innerHTML = "";
  const year = date.getFullYear();
  const month = date.getMonth();
  const days = new Date(year, month + 1, 0).getDate();
  document.getElementById("calendar-month").textContent = date.toLocaleString("default", { month: "long", year: "numeric" }).toUpperCase();

  for (let i = 1; i <= days; i++) {
    const d = new Date(year, month, i);
    const slug = d.toISOString().slice(0, 10);
    const el = document.createElement("div");
    el.className = "calendar-day";
    el.textContent = i;
    el.style.textAlign = "center";
    el.style.border = "1px solid #444";
    el.style.padding = "4px";
    el.style.cursor = "pointer";
    if (slug === new Date().toISOString().slice(0, 10)) el.style.fontWeight = "bold";
    el.onclick = () => {
      selectedCalendarSlug = slug;
      Array.from(grid.children).forEach(c => c.style.background = "");
      el.style.background = "#333";
    };
    grid.appendChild(el);
  }
}

document.getElementById("calendar-btn").onclick = () => {
  calendarDate = new Date();
  selectedCalendarSlug = null;
  calendarPopup.style.display = "flex";
  buildCalendarGrid(calendarDate);
};
document.getElementById("prev-month").onclick = () => {
  calendarDate.setMonth(calendarDate.getMonth() - 1);
  buildCalendarGrid(calendarDate);
};
document.getElementById("next-month").onclick = () => {
  calendarDate.setMonth(calendarDate.getMonth() + 1);
  buildCalendarGrid(calendarDate);
};
document.getElementById("calendar-create").onclick = () => {
  if (selectedCalendarSlug) {
    calendarPopup.style.display = "none";
    loadContent("daily", selectedCalendarSlug, "DAILY LOG", `https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/indexes/journal-${selectedCalendarSlug}.html`);
  }
};

function debounceSyncCollectionList() {
  clearTimeout(window._collSyncTimeout);
  window._collSyncTimeout = setTimeout(() => {
    fetch("https://bujolebron.netlify.app/.netlify/functions/dispatch", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        date: "collections-index",
        mode: "collections-index",
        content: encodeHTML(JSON.stringify(collectionsList))
      })
    });
  }, 800);
}

// INIT
window.onload = () => {
  try {
    const rec = localStorage.getItem("recent-entries");
    recentEntries = rec ? JSON.parse(rec) : [];
    renderRecents();
    loadCollectionsList();
    loadContent("daily", currentSlug, "DAILY LOG", `https://raw.githubusercontent.com/lebron1212/bulletjournal/main/journals/indexes/journal-${currentSlug}.html`);
  } catch (e) {
    console.error(e);
  }
};
</script>
</body>
</html>
